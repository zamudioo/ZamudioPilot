<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <style>
    body {
      background-color: #1e1e1e;
      font-family: 'Segoe UI', sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1 {
      margin-bottom: 20px;
    }

    .section {
      background-color: #2c2c2c;
      border-radius: 12px;
      padding: 15px;
      margin: 10px 0;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 0 10px #000;
    }

    .section h2 {
      margin-top: 0;
    }

    button {
      background-color: #444;
      border: none;
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background-color: #666;
    }
    input[type="text"] {
      padding: 10px;
      width: 70%;
      border-radius: 8px;
      border: none;
      margin-right: 5px;
    }

    #trackpad {
      width: 100%;
      height: 300px;
      background-color: #111;
      border: 2px dashed #555;
      border-radius: 12px;
      position: relative;
      touch-action: none;
      user-select: none;
    }

    #mouse-buttons {
      display: flex;
      width: 100%;
      margin-top: 10px;
    }
    #mouse-buttons button {
      flex: 1;
      height: 50px;
      margin: 0;
      border-radius: 0 0 8px 8px;
    }
    #mouse-buttons button:first-child {
      border-right: 1px solid #333;
    }
  </style>
</head>
<body>
  <h1>control</h1>

  <div class="section">
    <h2>Control de Volumen</h2>
    <button onclick="sendCommand('volume','up')">üîä +</button>
    <button onclick="sendCommand('volume','down')">üîâ -</button>
    <button onclick="sendCommand('volume','mute')">üîá</button>
  </div>

  <div class="section">
    <h2>Reproductor</h2>
    <button onclick="sendCommand('media','play_pause')">‚èØÔ∏è</button>
    <button onclick="sendCommand('media','next')">‚è≠Ô∏è</button>
    <button onclick="sendCommand('media','prev')">‚èÆÔ∏è</button>
  </div>

  <div class="section">
    <h2>Teclado</h2>
    <input type="text" id="keyboard-input" placeholder="Escribe algo..." />
    <button onclick="sendKeyboard()">Enviar</button>
  </div>

  <div class="section">
    <h2>Mouse (Trackpad)</h2>
    <div id="trackpad"></div>
    <div id="mouse-buttons">
      <button id="left-btn"></button>
      <button id="right-btn"></button>
    </div>
  </div>

  <script>
    const socket = io();

    function sendCommand(type, data) {
      socket.emit(type, data);
    }
    function sendKeyboard() {
      const text = document.getElementById('keyboard-input').value;
      socket.emit('keyboard', text);
    }
    document.getElementById('left-btn').addEventListener('click', () => {
      socket.emit('mouse_click', { button: 'left' });
    });
    document.getElementById('right-btn').addEventListener('click', () => {
      socket.emit('mouse_click', { button: 'right' });
    });

    // TRACKPAD GESTURES
    const trackpad = document.getElementById('trackpad');
    let pointers = new Map();
    let mode = 'none'; // 'drag' | 'scroll'
    let lastX = 0, lastY = 0, lastScrollY = 0;
    let twoFingerTap = false, gestureStart = 0;
    const TAP_TIME = 200;    // ms
    const TAP_MOVE = 10;     // px
    let initialPositions = new Map();

    trackpad.addEventListener('pointerdown', e => {
      pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
      if (pointers.size === 1) {
        mode = 'drag';
        lastX = e.clientX; lastY = e.clientY;
        socket.emit('mouse_down', { button: 'left' });
      } else if (pointers.size === 2) {
        // cancel possible drag
        if (mode === 'drag') {
          socket.emit('mouse_up', { button: 'left' });
        }
        mode = 'scroll';
        twoFingerTap = true;
        gestureStart = Date.now();
        // save initial positions
        initialPositions = new Map(pointers);
        // init scroll reference
        const ys = Array.from(pointers.values()).map(p => p.y);
        lastScrollY = (ys[0] + ys[1]) / 2;
      }
      trackpad.setPointerCapture(e.pointerId);
    });

    trackpad.addEventListener('pointermove', e => {
      if (!pointers.has(e.pointerId)) return;
      if (mode === 'drag' && pointers.size === 1) {
        const dx = e.clientX - lastX;
        const dy = e.clientY - lastY;
        lastX = e.clientX; lastY = e.clientY;
        socket.emit('mouse_move', { dx, dy });
      } else if (mode === 'scroll' && pointers.size === 2) {
        // check tap movement
        if (twoFingerTap) {
          const init = initialPositions.get(e.pointerId);
          if (Math.hypot(e.clientX - init.x, e.clientY - init.y) > TAP_MOVE) {
            twoFingerTap = false;
          }
        }
        // update pointer
        pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
        const ys = Array.from(pointers.values()).map(p => p.y);
        const avgY = (ys[0] + ys[1]) / 2;
        const dy = avgY - lastScrollY;
        lastScrollY = avgY;
        socket.emit('mouse_scroll', { dy: -dy });
      }
    });

    trackpad.addEventListener('pointerup', e => {
      if (!pointers.has(e.pointerId)) return;
      pointers.delete(e.pointerId);
      if (mode === 'drag' && pointers.size === 0) {
        socket.emit('mouse_up', { button: 'left' });
        mode = 'none';
      } else if (mode === 'scroll' && pointers.size === 0) {
        if (twoFingerTap && (Date.now() - gestureStart) < TAP_TIME) {
          socket.emit('mouse_click', { button: 'right' });
        }
        mode = 'none';
      }
      trackpad.releasePointerCapture(e.pointerId);
    });

    trackpad.addEventListener('pointercancel', e => {
      // limpiar estado
      pointers.clear();
      if (mode === 'drag') socket.emit('mouse_up', { button: 'left' });
      mode = 'none';
    });
  </script>
</body>
</html>
